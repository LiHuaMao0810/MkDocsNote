# Flow Matching 流匹配



## 目标

​	从**目标分布** $q$ 采样一些样本，我们的目标是生成属于目标分布的新样本。

​	为了解决这个问题，**流匹配**的思想是，构建一条**概率路径** $p_t$ ，从**源分布** $p_0$转换到目标分布$p_1 = q$ 。

​	具体的说，FM（flow matching）的目标是用神经网络拟合**速度场** $u_t$，用于唯一确定一个**流** $\psi_t(x)$。如果从源分布任意采样一个 $X_0$ 都满足
$$
X_t = \psi_t(X0) \sim p_t
$$
 也就是可以得到t时刻这个样本的演化结果，并且符合我们概率路径的分布，我们就说这个**速度场 $u_t$ 确实生成了对应的概率路径 $p_t$** 

同时，流还应该满足边界条件
$$
\psi_0(X_0) = X_0  \\
\psi_1(X_0) \sim q
$$
​	其中 $u_t$ 和 $\psi_t(x)$的关系由微分方程ODE定义：
$$
\frac{d}{dt} \psi_t(x) = u_t(\psi_t(x))
$$
​	不难发现速度场就是流的导数，方向，或者说演化的速度。

​	

- 图片和分布如何联系？

  把一张图片看作高维空间中的一个数据点，整个数据集看作高维空间的概率分布。

- 什么是源分布？

  是我们已知的分布，通常比较简单，比如高斯分布，因为他便于采样而且可能有良好的性质。也可能是和目标分布有关的分布，比如如果我们希望模型补全图片，或者对图片局部进行修改，那么源分布就是需要修改的图片。

- 什么是概率路径？

  通常我们约定这个转换的过程起始时间步为0，终点为1。概率路径 $p_t(0\le t \le 1)$ 可以看作一个关于t的函数，给定一个时间t，可以给出t时刻的数据分布。		

- 为什么要先构建一个概率路径，让速度场拟合概率路径，而不是让速度场直接决定概率路径？

  我觉得是先设计概率路径可以确保满足边界条件，保证结果正确。让速度场决定概率路径需要很多约束条件，非常难实现。



## 流匹配过程

​	![image-20250921123658977](./assets/image-20250921123658977.png)

1. 目标是找到一个流映射，将样本 $X_0$ 从已知的源或噪声分布 *q* 映射到来自未知的目标或数据分布*q* 的样本 $X_1$。 

2. 为此，设计一个时间连续概率路径 $p_t(0\le t \le 1)$，在 *p* := *p*0 和 *q* := *p*1 之间插值。 

3. 在训练期间，使用回归来估计生成 $p_t$ 的速度场 $u_t$。 

4. 要绘制一个新的目标样本 *X*1 *∼* *q*，从 *t* = 0 到 *t* = 1 积分估计的速度场 $u_t^\theta$，其中 *X*0 *∼* *p* 是一个新的源样本。

​	