# Flow Matching 流匹配



## 目标

​	从**目标分布** $q$ 采样一些样本，我们的目标是生成属于目标分布的新样本。

​	为了解决这个问题，流匹配的思想是，构建一条**概率路径** $p_t$ ，实际上是任意t时刻的数据分布，从**源分布** $p_0$转换到目标分布$p_1 = q$ 。

​	具体的说，FM（flow matching）的目标是用神经网络拟合**速度场** $u_t$，用于唯一确定一个**流** $\psi_t(x)$。如果从源分布任意采样一个 $X_0$ 都满足
$$
X_t = \psi_t(X0) \sim p_t
$$
 也就是可以得到t时刻这个样本的演化结果，并且符合我们概率路径的分布，我们就说这个**速度场 $u_t$ 确实生成了对应的概率路径 $p_t$** 

同时，流还应该满足边界条件
$$
\psi_0(X_0) = X_0  \\
\psi_1(X_0) \sim q
$$
​	其中 $u_t$ 和 $\psi_t(x)$的关系由微分方程ODE定义：
$$
\frac{d}{dt} \psi_t(x) = u_t(\psi_t(x))
$$
​	不难发现速度场就是流的导数，方向，或者说演化的速度。

​	

- 图片和分布如何联系？

  把一张图片看作高维空间中的一个数据点，整个数据集看作高维空间的概率分布。

- 什么是源分布？

  是我们已知的分布，通常比较简单，比如高斯分布，因为他便于采样而且可能有良好的性质。也可能是和目标分布有关的分布，比如如果我们希望模型补全图片，或者对图片局部进行修改，那么源分布就是需要修改的图片。

- 什么是概率路径？

  通常我们约定这个转换的过程起始时间步为0，终点为1。概率路径 $p_t(0\le t \le 1)$ 可以看作一个关于t的函数，给定一个时间t，可以给出t时刻的数据分布。		

- 为什么要先构建一个概率路径，让速度场拟合概率路径，而不是让速度场直接决定概率路径？

  我觉得是先设计概率路径可以确保满足边界条件，保证结果正确。让速度场决定概率路径需要很多约束条件，非常难实现。



## 流匹配过程

​	![image-20250921123658977](./assets/image-20250921123658977.png)

1. 目标是找到一个流映射，将样本 $X_0$ 从已知的源或噪声分布 *q* 映射到来自未知的目标或数据分布*q* 的样本 $X_1$。 

2. 为此，设计一个时间连续概率路径 $p_t(0\le t \le 1)$，在 $p := p_0 和 q := p_1$ 之间插值。 

3. 在训练期间，使用回归来估计生成 $p_t$ 的速度场 $u_t$。 

4. 要采样一个新的目标分布样本，可以从初始分布取样本$X _0$ ，通过从速度场的积分，也就是流映射，得到对应的目标样本$X _1$



### 1 设计概率路径

理解流匹配的蓝图之后，首先进行上述的第一步：设计一条概率路径。

我们设计概率路径的思想是，如果你知道目的地，那你直线走过去就行。所以对于每一个目标样本，我们可以得到一个后验的路径，也可以称之为条件路径。通过多次采样，然后将这些条件路径聚合，我们就得到了从源分布到目标分布的一个概率路径。这样设计的概率路径我们称之为**条件最优传输**或者**线性路径**，这也很好理解，因为我们的条件路径就是从源样本到目标样本的最优路径。这样的概率路径满足以下的公式：
$$
p_t(x) = \int p_{t|1}(x|x_1) q(x_1) \, dx_1, \quad \text{where } p_{t|1}(x|x_1) = \mathcal{N}(x | tx_1, (1-t)^2 I).
$$
使用这样的条件路径，我们可以通过采样源分布和目标分布，将他们线性组合得到随机变量
$$
X_t = t X_1 + (1-t) X_0 \sim p_t.
$$
​	

### 2 计算损失

设计概率路径之后，继续进行第二步：用神经网络生成的速度场 $u_{t}^{\theta}$ 来拟合概率路径的速度场，用简单的MSE损失很容易得到损失函数：
$$
\mathcal{L}_{\text{FM}}(\theta) = \mathbb{E}_{t, X_t} \left\| u_t^\theta(X_t) - u_t(X_t) \right\|^2, \quad \text{where } t \sim \mathcal{U}[0, 1] \text{ and } X_t \sim p_t.
$$
但是在实践中，使用这个公式依然有一些问题，就是目标速度场 $u _t$ 依然是一个非常复杂的对象，控制着两个高维分布的联合转换。幸好在我们设计的线性路径中，可以通过在单个目标上，对损失进行条件化，因为条件变量满足：
$$
X_{t|1} = t x_1 + (1-t) X_0 \quad \sim \quad p_{t|1}(\cdot | x_1) = \mathcal{N}(\cdot | t x_1, (1-t)^2 I).
$$
所以可以得到条件速度：
$$
u_t(x | x_1) = \frac{x_1 - x}{1 - t},
$$
从而得到条件概率路径 $p_{t|1}(\cdot | x_1)$

因此我们就得到了刚才损失函数的可计算版本：
$$
\mathcal{L}_{\text{CFM}}(\theta) = \mathbb{E}_{t, X_t, X_1} \left\| u_t^\theta(X_t) - u_t(X_t | X_1) \right\|^2, \quad \text{where } t \sim U[0, 1], \, X_0 \sim p, \, X_1 \sim q,
$$
将速度带入，就得到了最简单的流匹配实现：
$$
\mathcal{L}_{\text{CFM}}^{\text{OT, Gauss}}(\theta) = \mathbb{E}_{t, X_0, X_1} \left\| u_t^\theta(X_t) - (X_1 - X_0) \right\|^2, \quad \text{where } t \sim U[0, 1], \, X_0 \sim \mathcal{N}
$$
值得注意的是，这两个损失函数提供的学习梯度是一样的，后面的章节有证明（可能）

![image-20251126112807979](./assets/image-20251126112807979.png)